jQuery.noConflict()(function (e) {
  'use strict';
  initLetItSnow();
});

var initLetItSnow = function () {
  // requestAnimationFrame polyfill
  !(function () {
    var e =
      window.requestAnimationFrame ||
      window.mozRequestAnimationFrame ||
      window.webkitRequestAnimationFrame ||
      window.msRequestAnimationFrame ||
      function (e) {
        window.setTimeout(e, 1000 / 60);
      };
    window.requestAnimationFrame = e;
  })();

  // Config (can also be set in index.html)
  var opacitySnow = 0.1;       // base opacity
  var sizeSnow = 1;            // base size
  var speedSnow = 0.3;         // upward speed
  var disappearChance = 0.0005; // chance per frame to disappear mid-air
  var snow = [                  // ember colors
    "rgba(255,200,100,0.9)",
    "rgba(255,150,50,0.9)",
    "rgba(255,100,50,0.9)"
  ];
  var count = 18;               // number of embers

  var snowflakes = [],
      canvas = document.getElementById('snow'),
      ctx = canvas.getContext('2d');

  // initialize canvas
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  window.addEventListener('resize', function () {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  });

  // Reset ember
  function reset(f) {
    f.x = Math.random() * canvas.width;
    f.y = canvas.height - Math.random() * (canvas.height * 0.2); // start slightly above bottom
    f.size = .5 * Math.random() + sizeSnow;
    f.speed = 1 * Math.random() + speedSnow;
    f.velY = -f.speed; // upward
    f.velX = (Math.random() - 0.5) * 1; // small random horizontal start
    f.opacity = 0.6 * Math.random() + opacitySnow; // slightly stronger opacity
    f.color = snow[Math.floor(Math.random() * snow.length)];
    var shapes = ['circle','triangle','streak'];
    f.shape = shapes[Math.floor(Math.random() * shapes.length)];
    f.step = 0;
    f.stepSize = Math.random() / 30; // wobble amount
  }

  // create initial embers
  for (var i = 0; i < count; i++) {
    var f = {};
    reset(f);
    snowflakes.push(f);
  }

  // main animation loop
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (var i = 0; i < count; i++) {
      var f = snowflakes[i];

      // horizontal sway and vertical drift
      f.velX += Math.cos(f.step) * f.stepSize;
      f.velY += (Math.random() - 0.5) * 0.02; // small random vertical drift
      f.step += 0.05;

      f.x += f.velX;
      f.y += f.velY;

      // random burnout mid-air
      if (Math.random() < disappearChance) {
        reset(f);
      }

      // reset if out of bounds
      if (f.y <= 0 || f.y >= canvas.height) reset(f);
      if (f.x <= 0 || f.x >= canvas.width) reset(f);

      // draw ember based on shape
      ctx.fillStyle = f.color.replace(/[\d\.]+\)$/, f.opacity + ')');

      if (f.shape === 'circle') {
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.size, 0, 2 * Math.PI);
        ctx.fill();
      } else if (f.shape === 'triangle') {
        ctx.beginPath();
        ctx.moveTo(f.x, f.y);
        ctx.lineTo(f.x + f.size * (Math.random() - 0.5), f.y + f.size * (Math.random() - 0.5));
        ctx.lineTo(f.x + f.size * (Math.random() - 0.5), f.y + f.size * (Math.random() - 0.5));
        ctx.closePath();
        ctx.fill();
      } else if (f.shape === 'streak') {
        ctx.beginPath();
        ctx.ellipse(f.x, f.y, f.size * 0.5, f.size * 2, Math.random() * Math.PI, 0, 2 * Math.PI);
        ctx.fill();
      }
    }

    requestAnimationFrame(animate);
  }

  animate();
};
